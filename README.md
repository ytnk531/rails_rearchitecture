# Rails Re-architecture
## 概要
Railsの提供するアーキテクチャから外れたくなったときに使えるパターンの実装集です。

## パターン
### Unit of Work（ユニットオブワーク）
#### 概要
- データソースと同期が必要なオブジェクトをUnitOfWorkオブジェクトに保持しておき、データソースとの同期処理をまとめて行う。
#### メリット
- モデルを操作するコードでデータの更新タイミングを気にしなくて良くなる
- データ同期の方法に関する知識をUnit Of Workオブジェクトに閉じ込められる
#### 使いどき
- 複数のモデルに対する操作のトランザクションをひとまとめにしたいとき
- 更新を伴う時間のかかる処理をするときの、DBコネクション、トランザクションを張る時間を短くしたいとき
- 更新順序に関するロジックを単純にしたいとき
- 1リクエストにつき1トランザクションにしたいとき
#### コード
- `app/unit_of_works/unit_of_work.rb`
- `app/controllers/unit_of_works_controller.rb`

### Pessimistic Offline Lock (重オフラインロック）
#### 概要
- リクエストを横断した悲観的ロックを行う
- 書き込み用に読み込まれた際にロックを取得し、開放されるまで他の利用者からの読み込みを禁止する
#### メリット
- 1人の利用者が操作を開始してから完了するまでの間他の利用者からの操作を禁止するという仕組みを、複数回のHTTPリクエストにまたがって利用できる
#### 使い時
- 更新の競合が発生することを、データ更新操作の前（＝読み込みを試みたとき）に利用者に通知したいとき
- Railsの提供している悲観的ロックがロックするDBトランザクション中ではなく、ビジネスロジック上の一連の操作（＝ビジネストランザクション）中の悲観的ロックを行いたいとき
- アプリケーションからの操作時のみ悲観的ロックをしたいとき（Railsの提供している悲観的ロックはDBのテーブルロックを行うため、アプリケーションに限らず全てのSQLクライアントによる読み込み操作をロックする）
#### コード
- `app/models/lock_manager.rb`
- `app/controllers/pessimistic_offline_locks_controller.rb`

# References
Martin Fowler, エンタープライズアプリケーションアーキテクチャパターン, 翔泳社, 2005.
